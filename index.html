<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="manifest.json">
<title>Music Player</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --accent: #e94560;
    --accent-glow: rgba(233, 69, 96, 0.3);
    --text: #eee;
    --text-dim: #8892a4;
    --border: #2a3a5c;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-y: auto;
    -webkit-tap-highlight-color: transparent;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }

  .app {
    max-width: 480px;
    margin: 0 auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  header {
    text-align: center;
    padding: 12px 0;
    font-size: 1.3rem;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .add-btn {
    display: block;
    width: 100%;
    padding: 14px;
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: 12px;
    color: var(--text-dim);
    font-size: 1rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }
  .add-btn:active { border-color: var(--accent); color: var(--text); }

  #file-input { display: none; }

  .playlist {
    background: var(--surface);
    border-radius: 12px;
    overflow: hidden;
    max-height: 35vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .playlist-empty {
    padding: 24px;
    text-align: center;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  .song-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .song-item:last-child { border-bottom: none; }
  .song-item:active { background: rgba(233, 69, 96, 0.1); }

  .song-item.active {
    background: rgba(233, 69, 96, 0.15);
  }

  .song-num {
    font-size: 0.8rem;
    color: var(--text-dim);
    min-width: 20px;
    text-align: right;
  }
  .song-item.active .song-num { color: var(--accent); }

  .song-name {
    flex: 1;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .song-now {
    font-size: 0.75rem;
    color: var(--accent);
    font-weight: 600;
  }

  .song-remove {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 1.1rem;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
  }

  .player-section {
    background: var(--surface);
    border-radius: 12px;
    padding: 20px;
  }

  .controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    margin-bottom: 16px;
  }

  .ctrl-btn {
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.6rem;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: opacity 0.15s;
    line-height: 1;
  }
  .ctrl-btn:disabled { opacity: 0.3; cursor: default; }
  .ctrl-btn:active:not(:disabled) { opacity: 0.6; }

  .play-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }
  .play-btn:active:not(:disabled) { background: #c73a52; }

  .progress-wrap {
    margin-bottom: 8px;
  }

  .progress-bar {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    outline: none;
    cursor: pointer;
  }
  .progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  .random-pause-banner {
    background: var(--accent);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    display: none;
    animation: pulse-glow 1.5s ease-in-out infinite;
  }
  .random-pause-banner.visible { display: block; }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 10px var(--accent-glow); }
    50% { box-shadow: 0 0 25px var(--accent-glow); }
  }

  .random-pause-banner h3 {
    font-size: 1.1rem;
    margin-bottom: 12px;
  }

  .resume-btn {
    background: white;
    color: var(--accent);
    border: none;
    border-radius: 24px;
    padding: 12px 40px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
  }
  .resume-btn:active { opacity: 0.85; }

  .settings {
    background: var(--surface);
    border-radius: 12px;
    padding: 16px 20px;
  }

  .settings-title {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .range-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }
  .range-row:last-child { margin-bottom: 0; }

  .range-label {
    font-size: 0.9rem;
    min-width: 36px;
  }

  .range-input {
    -webkit-appearance: none;
    appearance: none;
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    outline: none;
  }
  .range-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .range-value {
    font-size: 0.9rem;
    min-width: 36px;
    text-align: right;
    color: var(--accent);
    font-weight: 600;
  }
</style>
</head>
<body>
<div class="app">
  <header>Music Player</header>

  <button class="add-btn" id="add-btn">+ Add Songs</button>
  <input type="file" id="file-input" multiple accept="audio/*">

  <div class="playlist" id="playlist">
    <div class="playlist-empty" id="playlist-empty">No songs added yet</div>
  </div>

  <div class="player-section">
    <div class="controls">
      <button class="ctrl-btn" id="prev-btn" disabled>&#9198;</button>
      <button class="ctrl-btn play-btn" id="play-btn" disabled>&#9654;&#65039;</button>
      <button class="ctrl-btn" id="next-btn" disabled>&#9197;</button>
    </div>
    <div class="progress-wrap">
      <input type="range" class="progress-bar" id="progress" value="0" min="0" max="1000" step="1">
    </div>
    <div class="time-display">
      <span id="time-current">0:00</span>
      <span id="time-total">0:00</span>
    </div>
  </div>

  <div class="random-pause-banner" id="pause-banner">
    <h3>Random Pause!</h3>
    <button class="resume-btn" id="resume-btn">Resume</button>
  </div>

  <div class="settings">
    <div class="settings-title">Random Pause Timer</div>
    <div class="range-row">
      <span class="range-label">Min</span>
      <input type="range" class="range-input" id="min-range" min="5" max="300" value="10">
      <span class="range-value" id="min-value">10s</span>
    </div>
    <div class="range-row">
      <span class="range-label">Max</span>
      <input type="range" class="range-input" id="max-range" min="5" max="300" value="40">
      <span class="range-value" id="max-value">40s</span>
    </div>
  </div>
</div>

<script>
(() => {
  // --- Built-in songs ---
  const BUILTIN_SONGS = [
    { name: 'Uptown Funk - Mark Ronson ft. Bruno Mars', url: 'songs/Mark Ronson - Uptown Funk Official Video ft Bruno Mars.mp3' },
    { name: 'Happy - Pharrell Williams', url: 'songs/Pharrell Williams - Happy from Despicable Me 2 Ballroom Version.mp3' },
    { name: 'Kiss Me - Sixpence None the Richer', url: 'songs/Sixpence None the Richer - Kiss Me Official Video.mp3' },
    { name: 'Dancing in the Moonlight - Toploader', url: 'songs/Toploader - Dancing in the Moonlight Official Video.mp3' },
  ];

  // --- State ---
  const songs = BUILTIN_SONGS.map(s => ({ ...s, builtin: true }));
  let currentIndex = 0;
  let randomPauseTimer = null;
  let isRandomPaused = false;
  let isSeeking = false;

  // --- Elements ---
  const audio = new Audio();
  const addBtn = document.getElementById('add-btn');
  const fileInput = document.getElementById('file-input');
  const playlistEl = document.getElementById('playlist');
  const playlistEmpty = document.getElementById('playlist-empty');
  const prevBtn = document.getElementById('prev-btn');
  const playBtn = document.getElementById('play-btn');
  const nextBtn = document.getElementById('next-btn');
  const progress = document.getElementById('progress');
  const timeCurrent = document.getElementById('time-current');
  const timeTotal = document.getElementById('time-total');
  const pauseBanner = document.getElementById('pause-banner');
  const resumeBtn = document.getElementById('resume-btn');
  const minRange = document.getElementById('min-range');
  const maxRange = document.getElementById('max-range');
  const minValue = document.getElementById('min-value');
  const maxValue = document.getElementById('max-value');

  // --- Helpers ---
  function formatTime(s) {
    if (!isFinite(s)) return '0:00';
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return m + ':' + (sec < 10 ? '0' : '') + sec;
  }

  function cleanFileName(name) {
    return name.replace(/\.[^.]+$/, '');
  }

  function getMinSec() { return parseInt(minRange.value, 10); }
  function getMaxSec() { return parseInt(maxRange.value, 10); }

  // --- Playlist rendering ---
  function renderPlaylist() {
    playlistEmpty.style.display = songs.length === 0 ? 'block' : 'none';

    // Remove existing song items
    playlistEl.querySelectorAll('.song-item').forEach(el => el.remove());

    songs.forEach((song, i) => {
      const item = document.createElement('div');
      item.className = 'song-item' + (i === currentIndex ? ' active' : '');
      item.innerHTML =
        '<span class="song-num">' + (i + 1) + '</span>' +
        '<span class="song-name">' + escapeHtml(song.name) + '</span>' +
        (i === currentIndex ? '<span class="song-now">NOW</span>' : '') +
        '<button class="song-remove" data-idx="' + i + '">&times;</button>';

      item.addEventListener('click', (e) => {
        if (e.target.classList.contains('song-remove')) return;
        playSong(i);
      });

      item.querySelector('.song-remove').addEventListener('click', (e) => {
        e.stopPropagation();
        removeSong(i);
      });

      playlistEl.appendChild(item);
    });

    updateControls();
  }

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function removeSong(idx) {
    const wasPlaying = idx === currentIndex;
    if (!songs[idx].builtin) URL.revokeObjectURL(songs[idx].url);
    songs.splice(idx, 1);

    if (songs.length === 0) {
      stopPlayback();
      currentIndex = -1;
    } else if (wasPlaying) {
      stopPlayback();
      if (idx >= songs.length) currentIndex = 0;
      else currentIndex = idx;
      playSong(currentIndex);
      return;
    } else if (idx < currentIndex) {
      currentIndex--;
    }

    renderPlaylist();
  }

  // --- Controls ---
  function updateControls() {
    const hasSongs = songs.length > 0;
    playBtn.disabled = !hasSongs;
    prevBtn.disabled = !hasSongs;
    nextBtn.disabled = !hasSongs;

    if (!audio.paused && !isRandomPaused) {
      playBtn.innerHTML = '&#9208;&#65039;';
    } else {
      playBtn.innerHTML = '&#9654;&#65039;';
    }
  }

  // --- Playback ---
  function playSong(index) {
    if (index < 0 || index >= songs.length) return;
    currentIndex = index;
    isRandomPaused = false;
    pauseBanner.classList.remove('visible');

    audio.src = songs[index].url;
    audio.play().catch(() => {});
    startRandomPauseTimer();
    renderPlaylist();
  }

  function stopPlayback() {
    audio.pause();
    audio.src = '';
    clearRandomPauseTimer();
    isRandomPaused = false;
    pauseBanner.classList.remove('visible');
    progress.value = 0;
    timeCurrent.textContent = '0:00';
    timeTotal.textContent = '0:00';
  }

  function playNext() {
    if (songs.length === 0) return;
    const next = currentIndex + 1;
    if (next < songs.length) {
      playSong(next);
    } else {
      stopPlayback();
      currentIndex = -1;
      renderPlaylist();
    }
  }

  function playPrev() {
    if (songs.length === 0) return;
    // If more than 3 seconds in, restart current song
    if (audio.currentTime > 3 && currentIndex >= 0) {
      audio.currentTime = 0;
      if (audio.paused) audio.play().catch(() => {});
      isRandomPaused = false;
      pauseBanner.classList.remove('visible');
      startRandomPauseTimer();
      return;
    }
    const prev = currentIndex - 1;
    if (prev >= 0) {
      playSong(prev);
    } else {
      playSong(0);
    }
  }

  // --- Random Pause ---
  function startRandomPauseTimer() {
    clearRandomPauseTimer();
    const minS = getMinSec();
    const maxS = Math.max(getMaxSec(), minS);
    const delay = (Math.random() * (maxS - minS) + minS) * 1000;
    randomPauseTimer = setTimeout(() => {
      if (!audio.paused) {
        audio.pause();
        isRandomPaused = true;
        pauseBanner.classList.add('visible');
        updateControls();
      }
    }, delay);
  }

  function clearRandomPauseTimer() {
    if (randomPauseTimer) {
      clearTimeout(randomPauseTimer);
      randomPauseTimer = null;
    }
  }

  // --- Event Listeners ---
  addBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      songs.push({ name: cleanFileName(file.name), url: URL.createObjectURL(file) });
    });
    fileInput.value = '';

    if (currentIndex === -1 && songs.length > 0) {
      currentIndex = 0;
    }

    renderPlaylist();
  });

  playBtn.addEventListener('click', () => {
    if (songs.length === 0) return;

    if (isRandomPaused) {
      // Resume from random pause
      isRandomPaused = false;
      pauseBanner.classList.remove('visible');
      audio.play().catch(() => {});
      startRandomPauseTimer();
    } else if (audio.paused) {
      if (currentIndex < 0) currentIndex = 0;
      if (!audio.src || audio.src === location.href) {
        playSong(currentIndex);
      } else {
        audio.play().catch(() => {});
        startRandomPauseTimer();
      }
    } else {
      audio.pause();
      clearRandomPauseTimer();
    }
    updateControls();
  });

  prevBtn.addEventListener('click', playPrev);
  nextBtn.addEventListener('click', playNext);

  resumeBtn.addEventListener('click', () => {
    isRandomPaused = false;
    pauseBanner.classList.remove('visible');
    audio.play().catch(() => {});
    startRandomPauseTimer();
    updateControls();
  });

  audio.addEventListener('timeupdate', () => {
    if (isSeeking) return;
    if (audio.duration) {
      progress.value = (audio.currentTime / audio.duration) * 1000;
      timeCurrent.textContent = formatTime(audio.currentTime);
      timeTotal.textContent = formatTime(audio.duration);
    }
  });

  audio.addEventListener('ended', () => {
    clearRandomPauseTimer();
    isRandomPaused = false;
    pauseBanner.classList.remove('visible');
    playNext();
  });

  audio.addEventListener('play', updateControls);
  audio.addEventListener('pause', updateControls);

  progress.addEventListener('input', () => {
    isSeeking = true;
    if (audio.duration) {
      timeCurrent.textContent = formatTime((progress.value / 1000) * audio.duration);
    }
  });

  progress.addEventListener('change', () => {
    if (audio.duration) {
      audio.currentTime = (progress.value / 1000) * audio.duration;
    }
    isSeeking = false;
    if (!audio.paused && !isRandomPaused) {
      startRandomPauseTimer();
    }
  });

  minRange.addEventListener('input', () => {
    let min = parseInt(minRange.value, 10);
    let max = parseInt(maxRange.value, 10);
    if (min > max) { maxRange.value = min; maxValue.textContent = min + 's'; }
    minValue.textContent = min + 's';
  });

  maxRange.addEventListener('input', () => {
    let min = parseInt(minRange.value, 10);
    let max = parseInt(maxRange.value, 10);
    if (max < min) { minRange.value = max; minValue.textContent = max + 's'; }
    maxValue.textContent = max + 's';
  });

  // --- PWA Registration ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

  // --- Init ---
  renderPlaylist();
})();
</script>
</body>
</html>
